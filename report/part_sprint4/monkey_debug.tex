\chapter{Running Monkey Tests on Debug Apps}
At the moment, the monkey tests are run on release versions of the apps. This is problematic as the \db{} groups work on automatic synchronization between devices and the production database. Obviously we do not want the monkey tests to insert dummy data into the production database. It could accidentally delete or modify some customers data if we allow it to test on the production database. We therefore need to make the monkey test the debug version of the apps instead, as the debug versions automatically use a development database. This corresponds to user story 3.

Prior to running the monkey test, the application to test has to be installed on the device. To make this installation easy, we put the newest version of each compiled debug application on the FTP server. We use a bash script to move the APK files from a specific project, shown in \listingref{lst:move_debug_apk}. The overall purpose of the script is to first delete the old version of the application from the FTP directory and then move the new one into the FTP directory. The application file is named using the scheme \code{[package name]\_v[version name]b[build number]\_debug\_aligned.apk}. To know which file corresponds to a specific application, we need the package name of the application. Part of this is found in line \ref{move_d:package} by performing the following steps:

\begin{enumerate}
  \item The package name is contained in the start of the name of the APK file. We use the \code{find} command to search for file names in the project directory which end in \mono{\_debug\_aligned.apk}.
  \item Afterwards, we pipe the file names to the \code{grep} command and use a regular expression to match anything up to and including the package name. The \code{P} option specifies the Perl regular expression syntax. The \code{o} options makes it so that only the matching part of the input string is printed. For example, \mono{grep} with the input \code{applications/dk.aau.cs.giraf.launcher\_v2.4b2\_debug\_aligned.apk} prints \code{applications/dk.aau.cs.giraf.launcher} (notice that the last part is the package name).
  \item The result of the match is stored in the variable \code{PACKAGE\_W\_PATH}
\end{enumerate}

In line \ref{move_d:empty-check} we check if an APK matching the naming scheme was found, by checking if \code{PACKAGE\_W\_PATH} is empty (the \code{z} option). If the resulting match is empty we exit, otherwise, we remove the path from the variable \code{PACKAGE\_W\_PATH} so we have only the package name left. We use this package name to remove the old apk from the FTP folder before we move the new APK to the FTP folder (lines \ref{move_d:move_start}--\ref{move_d:move_end}).

\begin{lstlisting}[language=bash,showstringspaces=false,caption=Script that moves the debug APK to the ftp server,label=lst:move_debug_apk]
#!/bin/bash

FTP_DIR="/srv/ftp/debug_apks/"
PACKAGE_W_PATH=$(find . -type f -name "*_debug_aligned.apk" -print | grep ".+(?=_v.+b[0-9]+_debug_aligned\.apk)" -Po) (*@\label{move_d:package}@*)
echo "FTP dir: "$FTP_DIR

if [ -z "$PACKAGE_W_PATH" ] (*@\label{move_d:empty-check}@*)
then
    echo "No file found"
    exit 1
else
    PACKAGE=$(basename $PACKAGE_W_PATH); (*@\label{move_d:move_start}@*)
    echo "Package: $PACKAGE"
    echo "Remove old files: $FTP_DIR$PACKAGE"*.apk
    rm "$FTP_DIR$PACKAGE"*.apk
    find . -type f -name "*_debug_aligned.apk" -print -exec mv {} "$FTP_DIR" \;
    exit 0 (*@\label{move_d:move_end}@*)
fi
\end{lstlisting}

We add the execution of the move script as a post-build task on all app jobs on Jenkins. We also update the monkey jobs to use the debug versions instead of the release versions. Hence, the user story is solved.