\chapter{Making Monkey Testing Work}
To make monkey testing work, we make a simple app that inserts dummy data into the local database. In addition all Giraf apps have to modified so that they accept a monkey test and uses the dummy data inserted into the database.

\section{Dummy Database Inserter}
To make sure that the local database contains data before starting the monkey test, we create a new Android application which inserts dummy data into the database. The application is very simple and the main part is shown in \listingref{lst:dummy_db_ins_main_activity}. It starts a thread which inserts the data using a method provided by the database library project. When inserted, the application closes. We detect when the applications has closed to know when the data has been inserted. In line 26, we call \mono{System.exit(0)} which ensures that the application is completely closed (killed), as it otherwise would just be in an idle state.

\begin{javacode}[caption=Dummy database inserter \mono{MainActivity},label=lst:dummy_db_ins_main_activity]
public class MainActivity extends Activity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        new DataInserter(this).execute();
    }

    private static class DataInserter extends AsyncTask<Void, Void, Void> {
        private Activity context;

        public DataInserter(Activity context) {
            this.context = context;
        }

        @Override
        protected Void doInBackground(Void... params) {
            new Helper(context).CreateDummyData();
            return null;
        }

        @Override
        protected void onPostExecute(Void aVoid) {
            // Force exit app (so we can detect it)
            context.finish();
            System.exit(0);
        }
    }
}
\end{javacode}

Having installed the dummy database inserter app onto a device, it must be started before running any monkey test. It is vital that the monkey test does not start before the dummy data has been inserted. Otherwise the database will not be populated with usable data.

We therefore make a script, seen in \listingref{lst:start_wait_dummy_db_inserter}, that starts the dummy database inserter app and waits for it to finish. It does so by first starting the app in line 1. It then runs a while loop (lines 5--9) that uses \mono{adb shell ps} to list all processes running on the Android device, and then piping that to \mono{grep} to check for the specific app. The loop runs for as long as the output is not empty. The loop sleeps so as to not use too much CPU.

\begin{lstlisting}[language=bash,showstringspaces=false,caption=Start and wait for dummy database inserter,label=lst:start_wait_dummy_db_inserter]
/srv/android-sdk-linux//platform-tools/adb shell am start -n dk.aau.cs.giraf.dummydbinserter/dk.aau.cs.giraf.dummydbinserter.MainActivity

IS_RUNNING="$(/srv/android-sdk-linux//platform-tools/adb shell ps | grep dk.aau.cs.giraf.dummydbinserter)"

while [ "$IS_RUNNING" ]
do
    IS_RUNNING="$(/srv/android-sdk-linux//platform-tools/adb shell ps | grep dk.aau.cs.giraf.dummydbinserter)"
    sleep 2
done

echo "finished dummy insertion"
\end{lstlisting}

\section{Adapting Giraf Apps for Monkey Testing}
Each Giraf application expects that it is started from the launcher, so that information about the current user is passed to the app. This prevents us from running monkey tests on the apps, as the monkey test will run the MainActivity of the app without providing this information, resulting in crashes or app closure (depending on the specific apps).

We circumvent this by detecting whether an app was started by a monkey test, if so we pull log in information from the database. The process various by each app. We show how to implement the change for the \emph{user manager} app in the activity \mono{MainActivity}.

The original code can be seen in \listingref{lst:main_activity_original}. When the MainActivity is created, it gets the given log in information (line 7). This information is then passed onto the \mono{getProfileFromExtras()} that gets a profile from this information. Line 14--19 shows a snippet of this method. It calls the \mono{signInWithGuardianId()} with the ID of a guardian.

In the modified version of user manager that supports monkey testing, seen in \listingref{lst:main_activity_monkey_test}, we add an if statement (line 7) that checks if the app was started by a monkey test. If it was we make a new \emph{Helper} (line 8), which is a database helper that enables us to get all guardians and select the ID of the first guardian (line 10). Instead of calling \mono{getProfileFromExtras()} we call \mono{signInWithGuardianId()} directly. If the app was not started by a monkey test we proceed as normal (line 12--15).

\begin{javacode}[caption=User manager MainActivity sign in original,label=lst:main_activity_original]
public class MainActivity extends FragmentActivity {
  // ...

  protected void onCreate(Bundle savedInstanceState) {
    // ...

    Bundle extras = getIntent().getExtras();
    getProfileFromExtras(extras);
    checkIfValidProfile();

    // ...
  }

  private void getProfileFromExtras(Bundle extras) {
    // ...
    } else if (extras.containsKey(EXTRAS_PROFILE_CURRENT_GUARDIAN_ID)) {
      signInWithGuardianId(extras.getInt(EXTRAS_PROFILE_CURRENT_GUARDIAN_ID));
    } // ...
  }

  // ...
}
\end{javacode}

\begin{javacode}[caption=User manager MainActivity with monkey test,label=lst:main_activity_monkey_test]
public class MainActivity extends FragmentActivity {
  // ...

  protected void onCreate(Bundle savedInstanceState) {
    // ...

    if (ActivityManager.isUserAMonkey()) {
      Helper h = new Helper(this);
      
      signInWithGuardianId(h.profilesHelper.getGuardians().get(0).getId());
    }
    else {
      Bundle extras = getIntent().getExtras();
      getProfileFromExtras(extras);
    }
    
    checkIfValidProfile();

    // ...
    }

  // ...
}
\end{javacode}

In this manner, we circumvent the expectations of the apps when running monkey tests. We create jobs on Jenkins which run monkey tests on all apps every night.